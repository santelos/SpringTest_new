BSLIB - C библиотека функций сканирования бюллетеней
BallotScannerLibrary - JAVA + C библиотека обеспечения взаимодействия модулей и приложения
PrinterLibrary - JAVA + C библиотека обеспечения печати на USB принтере
SIB - JAVA демонстрационное приложение
bsremote - приложение удаленного доступа к сканеру
binaries - пресобранные образы, приложения и пр.
AVD - описание виртуального девайса
bslib.txt - журнал версий BSLIB
bsjni.txt - журнал версий BallotScanerLibrary
bsjni.txt - журнал версий BallotScanerLibrary
prnjni.txt - журнал версий PrinterLibrary
linux.txt - журнал версий ядра Linux


							BSLIB

Модуль сканирования бюллетеней.

Состав проекта

jni/inc/bsapi.h - заголовок, который должен быть включен в приложении для использования функций API
jni/bsapi/local.h - приватный заголовок
jni/bsapi/bmp.h - заголовок для работы с BMP
jni/bsapi/bsapi.c - основной функционал модуля
jni/bsapi/utils.c - вспомогательные функции
jni/bsapi/scd.h - заголовок, интерфейса к драйверу сенсоров/протяжки/маркировщика
jni/bsapi/scd.c - работа с драйвером управления сенсорами/протяжкой/маркировщиком
jni/bsapi/afd.c - работа с драйвером загрузки прошивки Altera
jni/bsapi/i2c.c - работа с клиентами шины I2C (сопроцессор MSP, дытчики толщины бумаги, управление питанием)
jni/bsapi/rpc.c - функции удалённого доступа
jni/bsapi/que.c - очередь сообщений о сканированных данных
jni/bsapi/emu.c - эмуляция драйвера сканирующего механизма
jni/bsapi/log.c - функции логирования
jni/bsapi/ver.h - версия и протокол изменений

Принцип работы

В начале работы запускаются несколько потоков:
- поток диспетчера- обеспечивает выполнение последовательности действий, необходимых для сканирования документа
- поток опроса перефирии - опрашивает медленные устройства (датчики бумаги, источник питания, кнопки)
- поток передачи данных - отдает данные удаленному клиенто, согласовывая скорости сканирования и передачи
При запуске диспетчер переходит в состояние ожидания листа. 
В состоянии ожидания листа при обнаружении вставленного листа (показания двух датчиков меньше порогового значения для одного листа, но больше поргового значения для двух листов) пользователю (приложение или удаленный клиент) посылается однократно сообщение BS_EVT_SHEET_INSERTED. Если после этого показания датчиков изменятся каким-либо образом, то будет послано сообщение BS_EVT_SHEET_REMOVED. После получения команды BS_CMD_START диспетчер переходит в состояние сканирования. 
В состоянии сканирования идёт сканирование документа. Пока не будет обнаружен край листа сканированные данные игнорируются. Сканирование останавливается при наступлении одного из следующих событий:
- поступит команда BS_CMD_STOP - диспетчер перейдёт в состояние ожидания, при поступлении команды BS_CMD_START сканирование продолжится с текущегно места
- поступит команда BS_CMD_ACCEPT или BS_CMD_REJECT - диспетчер перейдёт в состояние протяжки листа
- будет превышена максимальная длина документа - диспетчер перейдет в состояние ожидания решения, пользователю будет послано сообщение BS_EVT_SHEET_OVERSIZED
- значение хотя бы одного из датчиков станет меньше порогового значения двойного листа - диспетчер перейдет в состояние ожидания решения, пользователю будет послано сообщение BS_EVT_SHEET_DOUBLED
- значение только одного из датчиков станет больше порогового значения листа - диспетчер перейдет в состояние ожидания решения, пользователю будет послано сообщение BS_EVT_SHEET_SKEWED
- значение обоих датчиков станет больше порогового значения листа - после доезда документа до сенсора диспетчер перейдет в состояние ожидания решения, пользователю будет послано сообщение BS_EVT_SHEET_FINISHED
- край документа не будет обнаружен за 1000 шагов - диспетчер перейдет в состояние ожидания решения, пользователю будет послано сообщение BS_EVT_SHEET_REMOVED
В процессе сканирования пользователь получает сообщения BS_EVT_SCAN_LINE с количеством отсканированных линий в качестве параметра каждые 64 линии.
Также пользователю посылаются сообщения BS_EVT_OBVERSE_DATA и BS_EVT_REVERSE_DATA, с адресом и размером одной скан-линии в формате, указанном в параметре команды BS_CMD_START (это нужно для передачи данных удалённому клиенту).
В состоянии ожидания решения диспетчер ждет команды от пользователя и НЕ опрашивает датчики бумаги. После получения команды BS_CMD_ACCEPT или BS_CMD_REJECT диспетчер переходит в состояние протяжки листа.
В состоянии протяжки листа диспетчер делает одно из:
- возвращает лист назад если была команда BS_CMD_REJECT; лист протягивается пока датчики бумаги не покажут, что листа нет, или не будет отсчитано кол-во шагов, сделанных при сканировании.
- протягивает лист вперёд если была команда BS_CMD_ACCEPT с параметром 0; лист протягивается пока датчики бумаги не покажут, что листа нет и ещё 500 шагов
- маркирует лист указанным кол-вом надрезов и протягивает лист вперёд если была команда BS_CMD_ACCEPT с не нулевым параметром; лист возвращается на несколько шагов назад, далее, двигаясь вперёд, лист надрезается указанное кол-во раз и, наконец, лист протягивается пока датчики бумаги не покажут, что листа нет и ещё 500 шагов
После этого диспетчер переходит в состояние ожидания листа.
Любая неисправность поизошедшая при работе диспетчера приводит к остановке работы и посылке пользователю сообщения BS_EVT_FAILURE.
В течении всего времени работы пользователю посылаются (могут посылаться) сообщения: 
- BS_EVT_CHARGING - с параметром 0, если батарея заряжается, 1, если батарея стала разряжается и 2, если батарея критически разряжена
- BS_EVT_BUTTON_PRESSED - если была нажата кнопка
- BS_EVT_SHEET_SENSOR - 4 раза в секунду
- BS_EVT_SUPPLY_VOLTAGE - 4 раза в секунду (не посылается удаленному клиенту)

Конфигурирование.

Конфигурирование может быть осуществлено несколькими способами в следующем порядке:
1. Конфигурация по умолчанию загружается из файла /tvhelp/default.cfg
2. Отладочная конфигурация загружается из файла /tvhelp/debug.cfg
3. Пользовательская конфигурация берётся из аргумента conf функции bsOpen.
Формат файлов *.cfg
<name>=<value><separator><name>=<value>...<separator><name>=<value>, где 
	name - имя параметра, 
	value - величина параметра, 
	separator - разделитель (':' или '\n')
Список параметров, формат записи и допустимые значения:
LOGDIR=<name>
	name - папка для записи логфайлов
	для записи лога в файл следует задать имя папки, доступной для записи, например /sd4
	для отключения логирования в файл нужно указать недоступную для записи папку (например /)
	лог файлы не удаляются приложением при заполнении диска
LOGLEV=<level>
	level - уровень логирования
	0 - только ошибки, 
	1 - ошибки и предупреждения
	2 - + информация
	3 - + трассировка
	>=4 - отладка
FWFILE=<name>
	name - полный путь к файла прошивки altera
YDPI=<dpi>
	dpi - разрешение сканнера в направлении протяжки листа
STEPPER=<start speed>|<scan speed>|<feed speed>|<drop speed>|<acceleration steps>||<coil current>
	start speed - стартовая скорость
	scan speed - скорость сканирования
	feed speed - скорость протяжки
	drop speed - скорость сброса
	acceleration - время разгона/торможения
	coil current - ток обмоток двигателя
	скорость задаётся в шагах в секунду, т.е. 1500 означает 1500*(25.4/200)=190.5 мм/сек
	ускорение задаётся в шагах (в настоящее время ДОЛЖНО быть 64)
	ток обмоток задаётся в процентах
SENSOR=<1st sensor single sheet>|<2nd sensor single sheet>|<1st sensor double sheet>|<2nd sensor double sheet>|<gap>
	single sheet - порговое значение, показания ниже которого трактуются как наличие листа
	double sheet - порговое значение, показания ниже которого трактуются как наличие двойного листа
	gap - кол-во шагов двигателя, которое надо сделать при сканировании после ухода листа с датчиков до остановки.
MARKER=<upper position>|<lower position>|<imitation position>
	upper position - верхнее положение дырокола
	lower position - нижнее положение дырокола
	imitation position - положение дырокола при иммитации маркировки
	положение задаётся в градусах (серводвигатели имеют разный диапазон движения и разную реакцию на превышения диапазона, т.е. при задании крайних значений надо убедиться, что серво двигатель отрабатывает данное значение)
SEPARATOR=<upper position>|<lower position>|<operating position>
	upper position - верхнее положение сортировщика
	lower position - нижнее положение сортировщика
	operating position - положение сортировщика при сканировании
	см. комментарии к MARKER
ADC=<visible gain>|<UV gain>|<reserved>||<visible offset>|<UV offset>|<reserved>
	visible gain - коэффициент усиления для видимого диапазона
	UV gain	- коэффициент усиления для ультрафиолетового диапазона
	visible offset - смещение для видимого диапазона
	UV offset - смещение для ультрафиолетового диапазона
	диапазон для усиления - [0..63], что соответствует усилению [0..15.56]dB
	диапазон для смещения - [-255..256], что соответствует смещению [-300..300]mV
CALIBR=<doit>
	doit - 1 - выполнять попиксельную калибровку, 0 - не выполнять
	для сканеров с UV сенсором не актуально
IPADDR=<addr>
	addr - IP адрес устройства
	для получения адреса по DHCP следует указать auto
	для использования адреса, полученного андроидом при загрузке (onboot.cmd) следует указать 0.0.0.0
IPMASK=<mask>
	mask - маска подсети
	для использования адреса, полученного андроидом при загрузке (onboot.cmd) следует указать 0.0.0.0
HRDREV=<bitfield>
	bitfield - флаги особенностей комплектации изделия
	bit0 - "старая" механика (тяжёлый вал, сенсор "видит" края листа)
	bit1 - камера не установлена
	bit2 - маркировщик не установлен
	bit3 - сортировщик не установлен
	bit4 - аккумулятор не установлен
	bit5 - датчик присутствия не установлен
	bit6 - напрвление чтения данных из сенсора. Устанавливать в 1 для всех прошивок для FPGA со 2 июня 2017.
DEBUG=<bitfield>
	bitfield - флаги отладки в двоичной системе
	бит0 - не ждать край листа при начале сканирования
	бит1 - сохранять фотографии и сканы во внутренней памяти (/sd4)
	бит2 - вращать двигатель в режиме ожидания
	бит3 - при сканировании сенсор выдаёт тестовый паттерн вместо изображения
	бит4 - сохранять лог андроида на внешнюю SD карту (только для варианта с андроидом на внутренней SD карте) !!! карта должна быть вставлена до включения сканера
	бит5 - позволять удаленным программам управлять сканером

Пример default.cfg:
	LOGDIR=.:LOGLEV=2:FWFILE=/tvhelp/altera.fw:YDPI=192:SPEED=500|3000|64:SENSOR=300|300||10|10||145:MARKER=11|168|90:SEPARATOR=11|168|60:ADC=30|0|32||0|-127|0:CALIBR=0:IPADDR=0.0.0.0:IPMASK=0.0.0.0:HRDREV=01010:DEBUG=10
Здесь
LOGDIR=. - записывать лог файлы в текущую папку приложения (иначе говоря отключить запись лога, т.к. у приложения нет прав)
LOGLEV=2 - установить уровень логирования INFO
FWFILE=/tvhelp/altera.fw - прошивать altera файлом /tvhelp/altera.fw
YDPI=192 - разрешение вдоль протяжки 192 точки на дюйм
SPEED=500|3000|64 - разгоняться с 250 до 1500 шагов в секунду
SENSOR=300|300||10|10||145 - пороги срабатывания одиночного листа - 300 и 300, пороги срабатывания двойного листа - 10 и 10, после окончания листа доезжать ещё 145 шагов
MARKER=11|168|90 - при пробивании двигаться от 11 градусов к 168, при имитации - от 11 градусов к 90.
SEPARATOR=11|168|60 - при возврате ставить в 11 градусов, при сбросе во второй лоток ставить в 168, при сканировании - в 60.
ADC=30|0|32||0|-127|0 - коэф. усиления видимого - 30, ультрафиолетового - 0, смещение видимого - 0, ультрафиолетового - -127
CALIBR=0 - не выполнять попиксельную калибровку
IPADDR=0.0.0.0 - использовать IP адрес из onboot.cmd
IPMASK=0.0.0.0
HRDREV=01010 - "новая" механика, сортировщик не установлен
DEBUG=10 - сохранять изображения в /sd4

Калибровка.

При включенной калибровке (CALIBR=1), каждый пиксель, считанный с сенсора пересчитывается по формуле v' = v * k / 128, где v - уровень серого с сенсора, v' - результат, k - калибровочный коэффициент. Калибровочные коэффициенты хранятся в бинарном файле /tvhelp/calibration.dat.

Логирование

Логирование идет в Android log и, опционально, в файл. Для включения логирования в файл необходимо в указать путь к лог файлу в конфигурационном параметре LOGDIR. Для отключения надо указать несуществующий или недоступный для записи путь. Логирование может вестись с 5 уровнями подробности. Уровень подробности задаётся в параметре LOGLEV.


						
							BallotScannerLibrary

Библиотека обеспечения взаимодействия модулей и приложения
jni/bsjni.c - основной функционал
jni/que.c - функции обеспечения очереди сообщений
src/ru.tvhelp.ballotscannerlibrary/Scanner.java - класс, обеспечивающий интерфейс между приложением и нативным кодом

							PrinterLibrary

Библиотека обеспечения печати на USB принтер
jni/prnjni.c - интерфейс между JAVA классом и модулем foo2zjs
jni/libfoo2zjs.so - сторонний модуль преобразование формата PBM в ZjStream
src/ru.tvhelp.printerlibrary/Printer.java - класс, обеспечивающий интерфейс между приложением и нативным кодом

								SIB

Демонстрационное приложение
src/ru.tvhelp.sib/SIB.java

								BSREMOTE

Установка IP адреса
Введите адрес и маску в соответствующие поля (для использования адреса полученного андроидом при загрузке введите адрес и маску 0.0.0.0, для получения адреса по DHCP введите в поле адреса "auto"). Нажмите Apply. Перезапустите SIB. 

Настройка сканера
1. Настройка датчиков листа
Для настройки датчиков листа предназначен "осциллограф", отображающий уровень сигнала на датчиках. Кроме того, на "осциллографе" отображаются пороговые уровни срабатывания одинарного и двойного листов. Уровни, относящиеся к разным датчикам отображаются красным и зелёным цветами.
Внесите в приёмную щель лист бумаги - на "осциллографе" вы увидите уровни для одинарного листа. Затем внесите ещё один лист - уровни датчиков снизятся. Изменяя параметры Single sheet treshold и Double sheet treshold, установите пороги срабатывания двойного листа между уровнями одинарного и двойного листов, а пороги срабатывания одинарного листа между уровнем одинарного листа и верхним краем "осциллографа".
2. Настройка АЦП сенсора
Для настройки АЦП предназначены гистограммы, которые отображаются в верхнем левом угле изображения при сканировании в полутоновом режиме. На гистограмме отображаются зоны в которые должны попадать белые и чёрные пиксели, а, также, порог бинаризации.
Убедитесь, что попиксельная коррекция отключена, т.е. значение параметра Calibration - Disable. Сканируйте лист с примерно равными по площади чёрными и белыми участками. На гистограме вы увидете два пика. Изменяйте параметры ADC gain и ADC offset так, чтобы пики максимально попадали в свои зоны, но при этом не было переэкспозиции. Для уменьшения общей яркости уменьшайте ADC offset, для увеличения яркости белого увеличивайте ADC gain. После достижения приемлемого результата, отсканируйте в полутоновом режиме чистый белый лист, нажмите кнопку Calibrate и установите параметр Calibration в Enable.
Запуск скриптов командной строки Linux.
Нажмите Linux shell command, выберите файл и нажмите OK. Например, скрипт printer.sh создаёт файл описания принтеров, определяющий соответствие подключенного принтера и параметров модуля foo2xxx.
